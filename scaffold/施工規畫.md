# 優化資料匯出工程

## 1. 相關程式碼位置

### 主要檔案位置：
- **事件匯出功能主檔案**: `client/lib/features/events/features/event_page/data/providers/event_provider.dart`
  - `generateRegistrationDataCsvFile()` 方法 (第368-443行) - 處理註冊資料匯出
  - `generateChatAndSugguestionsDataCsv()` 方法 (第445-518行) - 處理聊天和建議匯出

- **UI 觸發點**: `client/lib/features/events/features/event_page/presentation/widgets/event_info.dart`
  - `_downloadRegistrationData()` 方法 (第240-269行) - 觸發註冊資料下載
  - `_downloadChatsAndSuggestions()` 方法 (第271-289行) - 觸發聊天和建議下載

- **選單選項定義**: `client/lib/features/events/features/event_page/presentation/widgets/event_pop_up_menu_button.dart`
  - `EventPopUpMenuSelection` enum (第11-18行) - 定義下載選項
  - `_getText()` 方法 (第129-144行) - 定義選單文字
  - `_getIconAsset()` 方法 (第146-163行) - 定義選單圖示

## 2. CSV 格式差異分析

### Registration Data 差異比較：

**現有格式 (registration-data-current.csv):**
- Frankly ID → 需改為 User ID
- Member status → 需改為 Member Status (大小寫一致)
- 缺少 Join Time 欄位
- 缺少 Room Assigned 欄位  
- Answer 1, Answer 2 → 需改為實際問題文字或加上 Question 欄位

**新版格式 (registration-data-new.csv):**
- User ID (已修正)
- Member Status (已修正)
- 新增 Join Time 欄位
- 新增 Room Assigned 欄位
- 新增 Question 1, Question 2 欄位顯示問題文字

### Chats & Suggestions 差異比較：

**現有格式 (chats-suggestions-data-current.csv):**
- 聊天和建議混合在同一個檔案
- 使用 Name, Email 欄位
- RoomId 顯示實際 ID
- 包含 Type, #, Upvotes, Downvotes, AgendaItemId 等欄位

**新版格式分離：**

**Chat Data (chat-data-new.csv):**
- 只包含聊天資料
- 使用 User ID 取代 Name, Email
- Room 顯示房間名稱 (Main room, Waiting room, 1, 2, 3等)
- 移除 Type, #, Upvotes, Downvotes, AgendaItemId 欄位

**Polls & Suggestions (polls-suggestions-data-new.csv):**
- 包含投票和建議資料
- 使用 User ID 取代 Name, Email
- 新增 Prompt 欄位顯示議程項目提示文字
- Room 顯示房間名稱
- 保留 Upvotes, Downvotes 欄位

## 3. 施工順序安排

### Phase 1: Registration Data 優化 (最簡單)
**目標**: 直接修改 `generateRegistrationDataCsvFile()` 方法
**修改內容**:
- [x] 將 "Frankly ID" 改為 "User ID"
- [x] 將 "Member status" 改為 "Member Status" 
- [x] 新增 "Join Time" 欄位 (需要從參與者資料中取得首次加入時間)
- [x] 新增 "Room Assigned" 欄位 (需要從分組房間資料中取得)
- [x] 將 "Answer 1", "Answer 2" 改為 "Question 1", "Answer 1", "Question 2", "Answer 2" 格式
- [x] 檔案名稱改為 `registration-data-{$EventId}.csv`

### Phase 2: 分離 Chats & Suggestions 匯出函式
**目標**: 直接重構 `generateChatAndSugguestionsDataCsv()` 為兩個獨立方法
**修改內容**:
- [ ] 重構為 `generateChatDataCsv()` 方法 - 只處理聊天資料
- [ ] 重構為 `generatePollsSuggestionsDataCsv()` 方法 - 處理投票和建議資料
- [ ] 移除原有的混合方法

### Phase 3: Chat Data 格式優化
**目標**: 實作新的聊天資料匯出格式
**修改內容**:
- [ ] 移除 Type, #, Name, Email, Upvotes, Downvotes, AgendaItemId 欄位
- [ ] 將 "Created" 改為 "Time"
- [ ] 新增 "User ID" 欄位
- [ ] 將 "RoomId" 改為 "Room" 並顯示房間名稱
- [ ] 檔案名稱改為 `chat-data-{$EventId}.csv`

### Phase 4: Polls & Suggestions Data 格式優化  
**目標**: 實作新的投票和建議資料匯出格式
**修改內容**:
- [ ] 移除 Name, Email 欄位，新增 User ID 欄位
- [ ] 將 "Created" 改為 "Time"
- [ ] 新增 "Prompt" 欄位 (需要從議程項目取得提示文字)
- [ ] 將 "RoomId" 改為 "Room" 並顯示房間名稱
- [ ] 保留 Upvotes, Downvotes 欄位
- [ ] 檔案名稱改為 `polls-suggestions-data-{$EventId}.csv`

### Phase 5: UI 選單分離
**目標**: 將下載選單從一個按鈕分成兩個
**修改內容**:
- [ ] 在 `EventPopUpMenuSelection` enum 中新增 `downloadChatData` 和 `downloadPollsSuggestionsData`
- [ ] 修改 `_getMenuOptions()` 方法，顯示兩個分離的選項
- [ ] 修改 `_getText()` 方法，新增對應的文字
- [ ] 修改 `_getIconAsset()` 方法，新增對應的圖示
- [ ] 在 `event_info.dart` 中新增對應的處理方法
- [ ] 完全移除原有的 `downloadChatsAndSuggestions` 選項和相關方法

### Phase 6: 多語言優化
**目標**: 新增多語言支援
**修改內容**:
- [ ] 在 `client/lib/l10n/` 目錄中新增相關的多語言文字
- [ ] 更新所有硬編碼的英文文字為多語言鍵值
- [ ] 測試多語言顯示效果

## 4. 技術考量

### 資料來源需求：

#### **Join Time** (首次加入時間)
- **資料來源**: `Participant.mostRecentPresentTime` 欄位
- **檔案位置**: 
  - `data_models/lib/events/event.dart` (第308行) - Participant 模型定義
  - `client/lib/features/events/features/live_meeting/data/services/firestore_live_meeting_service.dart` (第330行) - 更新邏輯
- **說明**: 當使用者加入會議時會更新此欄位，記錄最近一次在場時間

#### **Room Assigned** (分組房間分配)
- **資料來源**: `Participant.currentBreakoutRoomId` 欄位 + `BreakoutRoom` 記錄
- **檔案位置**:
  - `data_models/lib/events/event.dart` (第301行) - Participant.currentBreakoutRoomId
  - `data_models/lib/events/live_meetings/live_meeting.dart` (第113-141行) - BreakoutRoom 模型
  - `firebase/functions/lib/events/live_meetings/breakouts/assign_to_breakouts.dart` - 分配邏輯
- **說明**: 參與者的 currentBreakoutRoomId 對應到 BreakoutRoom.roomId，可取得 roomName

#### **Question Text** (分組房間問題文字)
- **資料來源**: `BreakoutRoomDefinition.breakoutQuestions` 陣列
- **檔案位置**:
  - `data_models/lib/events/event.dart` (第446-460行) - BreakoutRoomDefinition 模型
  - `data_models/lib/events/event.dart` (第539-551行) - BreakoutQuestion 模型
- **說明**: 每個 BreakoutQuestion 有 title 和 answers，可取得問題文字和選項

#### **Prompt Text** (議程項目提示文字)
- **資料來源**: `AgendaItem.content` 或 `AgendaItem.title` 欄位
- **檔案位置**:
  - `data_models/lib/events/event.dart` (第378-411行) - AgendaItem 模型
  - `client/lib/features/events/features/live_meeting/features/meeting_agenda/presentation/agenda_item_presenter.dart` (第164-185行) - 內容處理邏輯
- **說明**: 根據 AgendaItemType 不同，content 或 title 包含提示文字

#### **Room Names** (房間名稱對應)
- **資料來源**: `BreakoutRoom.roomName` 欄位 + 常數定義
- **檔案位置**:
  - `data_models/lib/events/live_meetings/live_meeting.dart` (第109行) - `breakoutsWaitingRoomId = 'waiting-room'`
  - `data_models/lib/events/live_meetings/live_meeting.dart` (第119-121行) - BreakoutRoom.roomName
  - `firebase/functions/lib/events/live_meetings/breakouts/assign_to_breakouts.dart` (第604行) - 'Waiting Room' 名稱
- **說明**: 
  - 主房間: 通常沒有特定的 roomId，顯示為 "Main room"
  - 等待房間: roomId = 'waiting-room'，顯示為 "Waiting room"  
  - 分組房間: roomName 通常為數字 "1", "2", "3" 等

### 檔案命名策略：
- 現有檔案: `registration-data-current.csv`, `chats-suggestions-data-current.csv`
- 新版檔案: `registration-data-new.csv`, `chat-data-new.csv`, `polls-suggestions-data-new.csv`


